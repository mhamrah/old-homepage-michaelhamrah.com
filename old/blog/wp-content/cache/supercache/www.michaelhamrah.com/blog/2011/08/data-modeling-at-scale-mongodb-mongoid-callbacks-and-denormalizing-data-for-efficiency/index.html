<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<title>Data Modeling at Scale:  MongoDb + Mongoid, Callbacks, and Denormalizing Data for EfficiencyAdventures in HttpContext | Adventures in HttpContext</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="pingback" href="http://www.michaelhamrah.com/blog/xmlrpc.php" />
<!--[if lt IE 9]>
<script src="http://www.michaelhamrah.com/blog/wp-content/themes/publish/js/html5.js" type="text/javascript"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="Adventures in HttpContext &raquo; Feed" href="http://www.michaelhamrah.com/blog/feed/" />
<link rel="alternate" type="application/rss+xml" title="Adventures in HttpContext &raquo; Comments Feed" href="http://www.michaelhamrah.com/blog/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Adventures in HttpContext &raquo; Data Modeling at Scale:  MongoDb + Mongoid, Callbacks, and Denormalizing Data for Efficiency Comments Feed" href="http://www.michaelhamrah.com/blog/2011/08/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency/feed/" />
<link rel='stylesheet' id='jetpack-widgets-css'  href='http://www.michaelhamrah.com/blog/wp-content/plugins/jetpack/modules/widgets/widgets.css?ver=20121003' type='text/css' media='all' />
<link rel='stylesheet' id='publish-style-css'  href='http://www.michaelhamrah.com/blog/wp-content/themes/publish/style.css?ver=3.5.1' type='text/css' media='all' />
<link rel='stylesheet' id='sharedaddy-css'  href='http://www.michaelhamrah.com/blog/wp-content/plugins/jetpack/modules/sharedaddy/sharing.css?ver=2.2' type='text/css' media='all' />
<script type='text/javascript' src='http://www.michaelhamrah.com/blog/wp-includes/js/jquery/jquery.js?ver=1.8.3'></script>
<script type='text/javascript' src='http://www.michaelhamrah.com/blog/wp-content/plugins/jquery-syntax/jquery-syntax/jquery.syntax.min.js?ver=3.5.1'></script>
<script type='text/javascript' src='http://www.michaelhamrah.com/blog/wp-content/plugins/google-analyticator/external-tracking.min.js?ver=6.4.3'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.michaelhamrah.com/blog/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.michaelhamrah.com/blog/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Nina, My New Favorite Web (Micro)Framework' href='http://www.michaelhamrah.com/blog/2011/05/nina-my-new-favorite-web-microframework/' />
<link rel='next' title='Solr: Improving Performance and Other Considerations' href='http://www.michaelhamrah.com/blog/2011/11/solr-improving-performance-and-other-considerations/' />
<meta name="generator" content="WordPress 3.5.1" />
<link rel='shortlink' href='http://wp.me/pnRto-9h' />

<!-- All in One SEO Pack 1.6.15.3 by Michael Torbert of Semper Fi Web Design[122,255] -->
<meta name="description" content="I found myself confronted with a MongoDb data modeling problem. I have your vanilla User model which has many Items. The exact nature of an Item is" />
<link rel="canonical" href="http://www.michaelhamrah.com/blog/2011/08/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency/" />
<!-- /all in one seo pack -->
	<link rel="stylesheet" href="http://www.michaelhamrah.com/blog/wp-content/plugins/jquery-syntax/wp-fixes.css" type="text/css" media="screen" />
	<script type="text/javascript">
		jQuery.noConflict(); jQuery(document).ready(function($) { $.syntax({root: 'http://www.michaelhamrah.com/blog/wp-content/plugins/jquery-syntax/jquery-syntax/'}) });
	</script>

<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Data Modeling at Scale:  MongoDb + Mongoid, Callbacks, and Denormalizing Data for Efficiency" />
<meta property="og:url" content="http://www.michaelhamrah.com/blog/2011/08/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency/" />
<meta property="og:description" content="I found myself confronted with a MongoDb data modeling problem. I have your vanilla User model which has many Items. The exact nature of an Item is irrelevant, but let us say a User can have lots o..." />
<meta property="og:site_name" content="Adventures in HttpContext" />
<style type="text/css">
.widget_twitter li {
	word-wrap: break-word;
}
</style>
<!-- Google Analytics Tracking by Google Analyticator 6.4.3: http://www.videousermanuals.com/google-analyticator/ -->
<script type="text/javascript">
	var analyticsFileTypes = ['zip'];
	var analyticsEventTracking = 'enabled';
</script>
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-6576586-1']);
        _gaq.push(['_addDevId', 'i9k95']); // Google Analyticator App ID with Google 
        
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</head>

<body class="single single-post postid-575 single-format-standard">
<div id="page" class="hfeed site">
	<header id="masthead" class="site-header" role="banner">
					<a class="site-logo" href="http://www.michaelhamrah.com/blog/" title="Adventures in HttpContext" rel="home">
				<img class="no-grav" src="http://gravatar.com/avatar/de52b8e08282372084fdbcc4c2fe5f38/?s=100&#038;d=identicon" height="100" width="100" alt="Adventures in HttpContext" />
			</a>
				<hgroup>
			<h1 class="site-title"><a href="http://www.michaelhamrah.com/blog/" title="Adventures in HttpContext" rel="home">Adventures in HttpContext</a></h1>
			<h2 class="site-description">All the stuff after &quot;Hello, World!&quot;</h2>
		</hgroup>

		<nav role="navigation" class="site-navigation main-navigation">
			<h1 class="assistive-text">Menu</h1>
			<div class="assistive-text skip-link"><a href="#content" title="Skip to content">Skip to content</a></div>

			<div class="menu-home-container"><ul id="menu-home" class="menu"><li id="menu-item-808" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-808"><a href="http://www.michaelhamrah.com">Home</a></li>
<li id="menu-item-546" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-546"><a href="http://www.michaelhamrah.com/blog/about/">About</a></li>
<li id="menu-item-551" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-551"><a href="http://twitter.com/mhamrah">@mhamrah</a></li>
<li id="menu-item-552" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-552"><a href="http://www.flickr.com/photos/hamrah/tags/favorite/">Flickr</a></li>
<li id="menu-item-809" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-809"><a href="http://LinkedIn.com/in/Hamrah">LinkedIn</a></li>
</ul></div>		</nav><!-- .site-navigation .main-navigation -->

			</header><!-- #masthead .site-header -->

	<div id="main" class="site-main">
		<div id="primary" class="content-area">
			<div id="content" class="site-content" role="main">

			
				
<article id="post-575" class="post-575 post type-post status-publish format-standard hentry category-programming tag-architecture tag-cassandra tag-data-modeling tag-mongodb tag-mongoid tag-rails tag-ruby">
	<header class="entry-header">
		<h1 class="entry-title">Data Modeling at Scale:  MongoDb + Mongoid, Callbacks, and Denormalizing Data for Efficiency</h1>
	</header><!-- .entry-header -->

	<div class="entry-content">
		    <script type="text/javascript">
    // <![CDATA[
        var disqus_shortname = 'adventuresinhttpcontext';
        (function () {
            var nodes = document.getElementsByTagName('span');
            for (var i = 0, url; i < nodes.length; i++) {
                if (nodes[i].className.indexOf('dsq-postid') != -1) {
                    nodes[i].parentNode.setAttribute('data-disqus-identifier', nodes[i].getAttribute('rel'));
                    url = nodes[i].parentNode.href.split('#', 1);
                    if (url.length == 1) { url = url[0]; }
                    else { url = url[1]; }
                    nodes[i].parentNode.href = url + '#disqus_thread';
                }
            }
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + 'disqus.com/forums/' + disqus_shortname + '/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    //]]>
    </script>
<p>I found myself confronted with a MongoDb data modeling problem.  I have your vanilla User model which has many Items.  The exact nature of an Item is irrelevant, but let us say a User can have lots of Items.  I struggled with trying to figure out how to model this data in a flexible way while still leveraging the documented-orientated nature of MongoDb.  The answer may seem obvious to some but it is interesting to weigh the options available.</p>

<p><span id="more-575"></span></p>

<h3>To Embed or Not to Embed</h3>

<p>The main choice was to embed Items in a User or have that as a separate collection.  I do not think it makes sense to go vice versa, as Users are unique and clearly a top level entity.  It would not make sense to have thousands of the same User in an Items collection.  So the choice was between having Items in its own collection or embedding it in Users.  A couple of factors came into play:  How can I access, sort, or page through Item results if it is embedded in a User?  What happens if I had so many Items in a User class I hit the MongoDb 4mb document size limit? (Unlikely: 4mb is a lot of data, but I would certainly not want to have to refactor that logic later on!)  What would sharding look like with a large number of very large User documents?  Most importantly, at what point would the number of Items be problematic with this approach?  A hundred? A thousand? A hundred thousand?</p>

<h3>When to Embed</h3>

<p>I think embedded documents are an awesome feature of MongoDb, and the general approach, as recommended on the docs, is to say &#8220;Why wouldn&#8217;t I put this in an embedded document?&#8221;.  I would say if the number of Items a User would have is relatively small (say, enough that you would not need to page them on a UI, or if it would not create large network io by just accessing that field) then it can be an embedded document.  The decision is a lot simpler if it is a 1..1 relationship as the potential size is clearly defined.  1..N relationships break down with embedded relations when N becomes so large that accessing it as a whole is impractical.  As far as I know there does not seem to be a way to page or sort through an embedded array directly within MongoDb: you need to pull the entire field out of the database with field selection and then page on the client.  Note MongoDb offers numerous ways to find data within a document no matter how it is stored within the document (see the <a href="http://www.mongodb.org/display/DOCS/Dot+Notation+%28Reaching+into+Objects%29">docs on dot notation</a> for more).  You can even query on the position of elements in an array, which is helpful with sorted embedded lists (find me all Users who have Item Z as the first element).   But sadly you cannot say &#8220;give me the first to the Nth element in an embedded array&#8221;.  It is all or nothing.</p>

<p>Now Mongoid does offer the ability to page through an embedded association using a gem (seems like people use <a href="https://github.com/amatsuda/kaminari">Kaminari</a> as will_paginate was removed from Mongoid some time ago).  However, this paging is done within the ruby object for embedded relations.  More importantly, it is only done on a per-document basis. Under the hood you need to grab the entire embedded relation <em>embedded within its root document</em> (think an array of Users containing an array of Items, not a plain array of Items).  This means you cannot grab a collection of embedded documents which span multiple root documents.  You cannot say &#8220;give me all Items of type &#8216;X&#8217;.  You need to say &#8220;give me all Users and its Items containing Items of type &#8216;X&#8217;&#8221;.  If you ever ran into the &#8220;Access to the collection for XXX is not allowed since it is an embedded document, please access a collection from the root document&#8221; error you are probably trying to issue an unsupported Mongoid query by bypassing a root document.  You think you can treat embedded relations like normal collections, but you can&#8217;t.</p>

<h3>When to Have Separate Collections</h3>

<p>So where does that leave us:  If the relation is small enough, than an embedded relation is fine: we just need to realize that we can never really treat elements in that collection across its top level document and that getting those elements is an all-or-nothing decision for each parent document.  For the sake of argument, let us say a User can have thousands of Items, and we wanted the ability to list Items across Users in a single view.  That would be too much to manage as its own field as an embedded document, and we could not aggregate Items across Users easily.  So it needs to be in its own collection.  This now gives us numerous sorting options and paging features like skip and limit to reduce network traffic.  If we have Items as its own collection then we can create a DBRef between the two.  This is a classical relational breakdown.  The thing that smells with this approach, specifically when using MongoDb, is that if I were viewing a list of Items, and wanted to show the username associated with them, I would either have to use a DBRef command to pull user information or make two queries.  Less than ideal.  A JOIN would certainly be easier (albeit at scale, impractical, but probably for the DbRef approach too).</p>

<h3>The Solution</h3>

<p>So what I&#8217;m really looking for is the ability to show the username with a list of Items when each has its own collection.  The trick is I do not need to aggregate this data when I am pulling it out of the database.  Instead I can assemble it before I put in the database and it will all be there when I take it out.  Classic denormalization.  With Mongoid and <a href="http://mongoid.org/docs/callbacks.html">Callbacks</a> this becomes extremely easy.</p>

<p>On my Items class I add a <em>:belongs_to :user</em> property along with a <em>:username</em> property.  I want to ensure that a <em>:user</em> always exists, so I add a <em>validates_presence_of :user</em> validation.  I do not need to add <em>:username</em> to this validation as we will see below.  Then I leverage callbacks like so:</p>

<p><pre class="syntax ruby">
before_save :add_username</p>

<p>protected
def add_username
  if user_id_changed?
    self.username = user.username
  end
end
</pre></p>

<p>What will happen is if the User property changed Mongoid will set the current Item&#8217;s username value to the user.username property value. The username field is now stored within the Item document, and I can query on this field as easily as any other Item property (including the user_id relation on the Item document).  More importantly, it is already available in a query result so there is no need to make an additional query on User.username for display.  Any time the user changes (if Items can switch Users) the username will be updated automatically before the save to maintain consistency.  Because the :user object is required, there is no need to also make :username required.  Username will read from the required User property before each save.  There is a slight catch with this approach: callbacks will only be run on document which received the save call, so be careful with cascading updates.  As always a great test suite will always ensure the behavior you want is enforced.</p>

<h3>Sharding</h3>

<p>The other point about the user relation, whether it is via the username field or on user_id, is that it makes a good shard key.  If we shard off of this field (probably in conjunction of another key) you can control things like write scaling while keeping relevant data close together for querying.  For instance, sharding only on username will put all data in the same server to make querying a user&#8217;s items extremely efficient.  Sharding on username and something else will get writes distributed across servers at the expense of having to gather elements across servers when returning results.  The bottom line is know your use case: are faster writes more important than faster reads?  Which one are you doing more of?</p>

<h3>In Conclusion</h3>

<p>I think there are two important things to realize when it comes to modeling with not just Mongoid but with any type of data store, sql or nosql.  First when you are dealing with scale you want to put your data in the same way you want to get it out.  Know your data access patterns.  Sql allows a tremendous amount of flexibility, but joining numerous tables across millions of rows is extremely inefficient.  More importantly, if you model your data in NoSql incorrectly, you could end up with similar performance problems.  In the case of the data denormalization exercise above, adding a username field to the Items collections saves us from a DbRef later.  Plus, with the use of callbacks, getting our data into Mongoid in a denormalized way is easy.  We could easily apply the same principle to a sql-based solution: add a username column to a Item table or create a materialized view/indexed view on the Users/Items data.  If you are debating a no-sql solution over a sql one, take a look at the cost/benefit of one approach over another in terms of how easy it is to model your data around data access.  I think MongoDb gives a good amount of flexibility, especially with querying and indices, while still promoting some of the NoSql goodies like easy sharding for scalability and easy replication for reliability and read scaling.</p>

<p>Secondly, it is extremely important to know your toolset.  With MongoDb, you get a tremendous amount of querying power: filtering on any field, no matter the nesting, even if it&#8217;s an array; creating indices on said fields; map/reduce views; only retrieving specific fields from a document; the list is nearly endless.  ORM features are important too:  How does Mongoid map its API to MongoDB commands?  How does it deal with dirty tracking?  What callbacks are available?  The coolest thing on the <a href="http://www.mongoid.org">Mongoid</a> website is the statement <em>This is why the documentation provides the exact queries that Mongoid is executing against the database when you call a persistence operation. If we took the time to tell you, you should listen.</em>  VERY TRUE!  I like that.  The point being, there should be a purpose why you are choosing a NoSql solution: so know what it is and leverage it.  It will mean the difference of succeeding at scale or failing at launch.</p>

<h3>Cassandra</h3>

<p>As an interesting footnote, I think Cassandra exemplifies the query-first approach to data modeling (I mean, it states so on its wiki!).  Cassandra&#8217;s uniqueness is in its masterless approach as a key/value store.  It comes with some interesting features: the choice of using a secondary index vs. columnfamily as index, numerous comparison operators on columnfamily names, super columns vs. columns for storing data, replication and write consistency options across multiple data centers.  This leads to plenty of benefits but with a certain cost.  As for the know your tools/know your data philosophy, an example is the typical choice of &#8220;Do you create a row and use its respected columns as an index, choosing an appropriate column comparison type, or do you treat your data as a key/value store and use a secondary index for queries?&#8221;  One the one hand, you have a pre-sorted list that queries from one machine and with one call with slices for paging; on the other, you may need to farm out to a lot of machines to get the data you want.  Knowing your options is important, and knowing what you have to do to implement your choice is nearly as important.  Even with the best Cassandra ORMs you still need to do a lot of prep to get your data into and out of Cassandra in a meaningful way.</p>

<h3>Final Thought</h3>

<p>In a bit of contradictory advice, I&#8217;d say don&#8217;t sweat it too much.  Do some preliminary research, go with your hunch and trust your ability to refactor when needed.  If you wait to figure out the perfect solution, you won&#8217;t build anything!</p>
<div class="sharedaddy sd-sharing-enabled"><div class="robots-nocontent sd-block sd-social sd-social-icon-text sd-sharing"><h3 class="sd-title">Share this:</h3><div class="sd-content"><ul><li class="share-twitter"><a rel="nofollow" class="share-twitter sd-button share-icon" href="http://www.michaelhamrah.com/blog/2011/08/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency/?share=twitter" title="Click to share on Twitter" id="sharing-twitter-575"><span>Twitter</span></a></li><li class="share-linkedin"><a rel="nofollow" class="share-linkedin sd-button share-icon" href="http://www.michaelhamrah.com/blog/2011/08/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency/?share=linkedin" title="Click to share on LinkedIn" id="sharing-linkedin-575"><span>LinkedIn</span></a></li><li class="share-facebook"><a rel="nofollow" class="share-facebook sd-button share-icon" href="http://www.michaelhamrah.com/blog/2011/08/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency/?share=facebook" title="Share on Facebook" id="sharing-facebook-575"><span>Facebook</span></a></li><li class="share-google-plus-1"><a rel="nofollow" class="share-google-plus-1 sd-button share-icon" href="http://www.michaelhamrah.com/blog/2011/08/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency/?share=google-plus-1" title="Click to share on Google+" id="sharing-google-575"><span>Google +1</span></a></li><li class="share-end"></li></ul><div class="sharing-clear"></div></div></div></div><div class='yarpp-related'>
<strong class="related_posts">Related Posts:</strong> <ol>
<li><a href='http://www.michaelhamrah.com/blog/2010/12/machinist-2-mongoid-embeds_many-goodness/' rel='bookmark' title='Machinist 2 + Mongoid + Embeds_Many Goodness'>Machinist 2 + Mongoid + Embeds_Many Goodness</a></li>
</ol>
<img src='http://yarpp.org/pixels/288c3ec03cb337c2e83ff8ec6c6de897'/>
</div>
			</div><!-- .entry-content -->

	<footer class="entry-meta">
		Posted on <a href="http://www.michaelhamrah.com/blog/2011/08/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency/" title="11:32 pm" rel="bookmark"><time class="entry-date" datetime="2011-08-11T23:32:23+00:00" pubdate>August 11, 2011</time></a><span class="byline"> by <span class="author vcard"><a class="url fn n" href="http://www.michaelhamrah.com/blog/author/admin/" title="View all posts by Michael" rel="author">Michael</a></span></span>.		This entry was posted in <a href="http://www.michaelhamrah.com/blog/category/programming/" title="View all posts in Programming" rel="category tag">Programming</a> and tagged <a href="http://www.michaelhamrah.com/blog/tag/architecture/" rel="tag">architecture</a>, <a href="http://www.michaelhamrah.com/blog/tag/cassandra/" rel="tag">cassandra</a>, <a href="http://www.michaelhamrah.com/blog/tag/data-modeling/" rel="tag">data modeling</a>, <a href="http://www.michaelhamrah.com/blog/tag/mongodb/" rel="tag">mongodb</a>, <a href="http://www.michaelhamrah.com/blog/tag/mongoid/" rel="tag">mongoid</a>, <a href="http://www.michaelhamrah.com/blog/tag/rails/" rel="tag">rails</a>, <a href="http://www.michaelhamrah.com/blog/tag/ruby/" rel="tag">ruby</a>. Bookmark the <a href="http://www.michaelhamrah.com/blog/2011/08/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency/" title="Permalink to Data Modeling at Scale:  MongoDb + Mongoid, Callbacks, and Denormalizing Data for Efficiency" rel="bookmark">permalink</a>.
			</footer><!-- .entry-meta -->
</article><!-- #post-575 -->

					<nav role="navigation" id="nav-below" class="site-navigation post-navigation">
		<h1 class="assistive-text">Post navigation</h1>

	
		<div class="nav-previous"><a href="http://www.michaelhamrah.com/blog/2011/05/nina-my-new-favorite-web-microframework/" rel="prev"><span class="meta-nav">&larr;</span> Nina, My New Favorite Web (Micro)Framework</a></div>		<div class="nav-next"><a href="http://www.michaelhamrah.com/blog/2011/11/solr-improving-performance-and-other-considerations/" rel="next">Solr: Improving Performance and Other Considerations <span class="meta-nav">&rarr;</span></a></div>
	
	</nav><!-- #nav-below -->
	
				
<div id="disqus_thread">
                    <div id="dsq-content">


            <ul id="dsq-comments">
                    <li class="comment even thread-even depth-1" id="dsq-comment-1856">
        <div id="dsq-comment-header-1856" class="dsq-comment-header">
            <cite id="dsq-cite-1856">
http://benzittlau.com                <span id="dsq-author-user-1856">Ben Zittlau</span>
            </cite>
        </div>
        <div id="dsq-comment-body-1856" class="dsq-comment-body">
            <div id="dsq-comment-message-1856" class="dsq-comment-message"><p>I might be missing something, but it seems like with this approach you&#8217;d have a problem when the username is modified on the user object.  The value stored in the Item will be the old value of the username, but because the Item has not been changed (and the user_id will still be the same), the username in the Item will not be updated to match.</p>

<p>You&#8217;d either need some form of consistency checker running to update the item values based on the user id, or have a filter triggered to go and find and update all Items whenever a user changes their username.</p>
</div>
        </div>

    </li>
    <li class="comment byuser comment-author-admin bypostauthor odd alt thread-odd thread-alt depth-1" id="dsq-comment-1857">
        <div id="dsq-comment-header-1857" class="dsq-comment-header">
            <cite id="dsq-cite-1857">
http://www.michaelhamrah.com                <span id="dsq-author-user-1857">Michael</span>
            </cite>
        </div>
        <div id="dsq-comment-body-1857" class="dsq-comment-body">
            <div id="dsq-comment-message-1857" class="dsq-comment-message"><p>Hey Ben, you are absolutely correct: with this approach, you need to ensure data you are denormalizing is kept in sync when changed.  However, how often do you change usernames?  For a majority of websites, there is usually no way to change your username.  That&#8217;s to say it never happens, nor that there wouldn&#8217;t be another use case with a different field where this would be an issue.</p>

<p>Again, you need to evaluate your data access patterns.  With the NoSQL movement you cannot think in relational terms.  Scaling NoSQL means put the data in the way you want it out so you eliminate joins and numerous round trips.  There are consequences to that which must be weighed and evaluated.</p>
</div>
        </div>

    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://highlyscalable.wordpress.com/2012/03/01/nosql-data-modeling-techniques/' rel='external nofollow' class='url'>NoSQL Data Modeling Techniques &laquo; Highly Scalable Blog</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://candidosalesg.wordpress.com/2012/03/12/nosql-data-modeling-techniques/' rel='external nofollow' class='url'>NoSQL Data Modeling Techniques &laquo; Cândido Sales Blog</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://jamisonwhite.com/2012/04/24/nosql-data-modeling-techniques/' rel='external nofollow' class='url'>NoSQL Data Modeling Techniques &laquo; Jamison White&#039;s Blog</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://coolshell.cn/articles/7270.html' rel='external nofollow' class='url'>NoSQL 数据建模技术 | 酷壳 - CoolShell.cn</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://tech.fblife.com/?p=179' rel='external nofollow' class='url'>NoSQL 数据建模技术 at 越野e族-Tech</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://blog.jobbole.com/19533/' rel='external nofollow' class='url'>NoSQL 数据建模技术 - 博客 - 伯乐在线</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://quanxinxi.com/2012/05/15/nosql-%e6%95%b0%e6%8d%ae%e5%bb%ba%e6%a8%a1%e6%8a%80%e6%9c%af/' rel='external nofollow' class='url'>NoSQL 数据建模技术 | 全信息-互联网深度阅读体验</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://blog.saihzy.com/db/nosql-data-modeling-techniques.html' rel='external nofollow' class='url'>NoSQL 数据建模技术 | SAi&amp;Young</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://cwyalpha.wordpress.com/2012/05/18/thought-this-was-cool-nosql-%e6%95%b0%e6%8d%ae%e5%bb%ba%e6%a8%a1%e6%8a%80%e6%9c%af/' rel='external nofollow' class='url'>Thought this was cool: NoSQL 数据建模技术 &laquo; CWYAlpha</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://www.chinasb.org/archives/2012/05/4653.shtml' rel='external nofollow' class='url'>NoSQL 数据建模技术 | Chinasb&#039;s Blog</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://cuzn.wulai.cn/blog/?p=17' rel='external nofollow' class='url'>$Cu_zn - NoSQL 数据建模技术</a></p>
    </li>
    </li>
    <li class="post pingback">
        <p>Pingback: <a href='http://crescosolution.com/nosql-data-modeling-techniques/' rel='external nofollow' class='url'>NoSQL Data Modeling Techniques | Cresco solution</a></p>
    </li>
    </li>
            </ul>


        </div>

    </div>

<script type="text/javascript">
/* <![CDATA[ */
    var disqus_url = 'http://www.michaelhamrah.com/blog/2011/08/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency/';
    var disqus_identifier = '575 http://www.michaelhamrah.com/blog/?p=575';
    var disqus_container_id = 'disqus_thread';
    var disqus_domain = 'disqus.com';
    var disqus_shortname = 'adventuresinhttpcontext';
    var disqus_title = "Data Modeling at Scale:  MongoDb + Mongoid, Callbacks, and Denormalizing Data for Efficiency";
        var disqus_config = function () {
        var config = this; // Access to the config object
        config.language = '';

        /*
           All currently supported events:
            * preData — fires just before we request for initial data
            * preInit - fires after we get initial data but before we load any dependencies
            * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
            * afterRender - fires when template is rendered but before we show it
            * onReady - everything is done
         */

        config.callbacks.preData.push(function() {
            // clear out the container (its filled for SEO/legacy purposes)
            document.getElementById(disqus_container_id).innerHTML = '';
        });
                config.callbacks.onReady.push(function() {
            // sync comments in the background so we don't block the page
            var script = document.createElement('script');
            script.async = true;
            script.src = '?cf_action=sync_comments&post_id=575';

            var firstScript = document.getElementsByTagName( "script" )[0];
            firstScript.parentNode.insertBefore(script, firstScript);
        });
                    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
    var DsqLocal = {
        'trackbacks': [
            {
                'author_name':    "NoSQL Data Modeling Techniques &laquo; Highly Scalable Blog",
                'author_url':    "http:\/\/highlyscalable.wordpress.com\/2012\/03\/01\/nosql-data-modeling-techniques\/",
                'date':            "03\/01\/2012 08:55 AM",
                'excerpt':        "[...] http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "NoSQL Data Modeling Techniques &laquo; Cândido Sales Blog",
                'author_url':    "http:\/\/candidosalesg.wordpress.com\/2012\/03\/12\/nosql-data-modeling-techniques\/",
                'date':            "03\/12\/2012 05:59 PM",
                'excerpt':        "[...] http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "NoSQL Data Modeling Techniques &laquo; Jamison White&#039;s Blog",
                'author_url':    "http:\/\/jamisonwhite.com\/2012\/04\/24\/nosql-data-modeling-techniques\/",
                'date':            "04\/24\/2012 10:28 AM",
                'excerpt':        "[...] http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "NoSQL 数据建模技术 | 酷壳 - CoolShell.cn",
                'author_url':    "http:\/\/coolshell.cn\/articles\/7270.html",
                'date':            "05\/14\/2012 09:51 PM",
                'excerpt':        "[...] http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "NoSQL 数据建模技术 at 越野e族-Tech",
                'author_url':    "http:\/\/tech.fblife.com\/?p=179",
                'date':            "05\/14\/2012 10:28 PM",
                'excerpt':        "[...] http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "NoSQL 数据建模技术 - 博客 - 伯乐在线",
                'author_url':    "http:\/\/blog.jobbole.com\/19533\/",
                'date':            "05\/14\/2012 11:37 PM",
                'excerpt':        "[...] 2. http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "NoSQL 数据建模技术 | 全信息-互联网深度阅读体验",
                'author_url':    "http:\/\/quanxinxi.com\/2012\/05\/15\/nosql-%e6%95%b0%e6%8d%ae%e5%bb%ba%e6%a8%a1%e6%8a%80%e6%9c%af\/",
                'date':            "05\/15\/2012 07:05 AM",
                'excerpt':        "[...] 2. http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "NoSQL 数据建模技术 | SAi&amp;Young",
                'author_url':    "http:\/\/blog.saihzy.com\/db\/nosql-data-modeling-techniques.html",
                'date':            "05\/18\/2012 03:24 AM",
                'excerpt':        "[...] 2. http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "Thought this was cool: NoSQL 数据建模技术 &laquo; CWYAlpha",
                'author_url':    "http:\/\/cwyalpha.wordpress.com\/2012\/05\/18\/thought-this-was-cool-nosql-%e6%95%b0%e6%8d%ae%e5%bb%ba%e6%a8%a1%e6%8a%80%e6%9c%af\/",
                'date':            "05\/18\/2012 01:26 PM",
                'excerpt':        "[...] http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "NoSQL 数据建模技术 | Chinasb&#039;s Blog",
                'author_url':    "http:\/\/www.chinasb.org\/archives\/2012\/05\/4653.shtml",
                'date':            "05\/20\/2012 01:02 PM",
                'excerpt':        "[...] http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "$Cu_zn - NoSQL 数据建模技术",
                'author_url':    "http:\/\/cuzn.wulai.cn\/blog\/?p=17",
                'date':            "06\/02\/2012 06:25 AM",
                'excerpt':        "[...] http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
,            {
                'author_name':    "NoSQL Data Modeling Techniques | Cresco solution",
                'author_url':    "http:\/\/crescosolution.com\/nosql-data-modeling-techniques\/",
                'date':            "03\/06\/2013 02:38 PM",
                'excerpt':        "[...] http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denor... [...]<br \/>",
                'type':            "pingback"            }
        ],
        'trackback_url': "http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency\/trackback\/"    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.' + 'disqus.com' + '/embed.js?pname=wordpress&pver=2.74';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

			
			</div><!-- #content .site-content -->
		</div><!-- #primary .content-area -->

		<div id="secondary" class="widget-area" role="complementary">
						<aside id="twitter-3" class="widget widget_twitter"><h1 class="widget-title"><a href='http://twitter.com/mhamrah'>Twitter Updates</a></h1><ul class='tweets'>
			<li>
				@<a href='http://twitter.com/agebhard'>agebhard</a> Ja, es ist gut. Es ist gut. 				<a href="http://twitter.com/mhamrah/statuses/312538977448116224" class="timesince">1&nbsp;hour&nbsp;ago</a>
			</li>

			
			<li>
				@<a href='http://twitter.com/agebhard'>agebhard</a> I picture you sitting on a log cabin porch smoking a huge pipe, angrily grinning at the horizon, but it&#039;s really a German smile. 				<a href="http://twitter.com/mhamrah/statuses/312537991950249984" class="timesince">1&nbsp;hour&nbsp;ago</a>
			</li>

			
			<li>
				RT @<a href='http://twitter.com/subchild'>subchild</a>: Digg Blog, We&#039;re Building A Reader: <a href="http://blog.digg.com/post/45355701332/were-building-a-reader#.UUJTagci1Pw.twitter"> blog.digg.com/post/453557013…</a> 				<a href="http://twitter.com/mhamrah/statuses/312338856890466304" class="timesince">14&nbsp;hours&nbsp;ago</a>
			</li>

			</ul></aside>		</div><!-- #secondary .widget-area -->

	</div><!-- #main .site-main -->

	<footer id="colophon" class="site-footer" role="contentinfo">
		<div class="site-info">
			<a href="http://wordpress.org/" rel="generator">Proudly powered by WordPress</a> Theme: Publish by <a href="http://kovshenin.com/" rel="designer">Konstantin Kovshenin</a>.		</div><!-- .site-info -->
	</footer><!-- #colophon .site-footer -->
</div><!-- #page .hfeed .site -->

	<div style="display:none">
	</div>

	<script type="text/javascript">
		WPCOM_sharing_counts = {"http:\/\/www.michaelhamrah.com\/blog\/2011\/08\/data-modeling-at-scale-mongodb-mongoid-callbacks-and-denormalizing-data-for-efficiency\/":575}	</script>
<script type='text/javascript' src='http://www.michaelhamrah.com/blog/wp-content/plugins/jetpack/modules/sharedaddy/sharing.js?ver=20121205'></script>
		<script type="text/javascript">
		jQuery(document).on( 'ready post-load', function(){
			jQuery( 'a.share-twitter' ).on( 'click', function() {
				window.open( jQuery(this).attr( 'href' ), 'wpcomtwitter', 'menubar=1,resizable=1,width=600,height=350' );
				return false;
			});
		});
		</script>
				<script type="text/javascript">
		jQuery(document).on( 'ready post-load', function(){
			jQuery( 'a.share-linkedin' ).on( 'click', function() {
				window.open( jQuery(this).attr( 'href' ), 'wpcomlinkedin', 'menubar=1,resizable=1,width=580,height=450' );
				return false;
			});
		});
		</script>
				<script type="text/javascript">
		jQuery(document).on( 'ready post-load', function(){
			jQuery( 'a.share-facebook' ).on( 'click', function() {
				window.open( jQuery(this).attr( 'href' ), 'wpcomfacebook', 'menubar=1,resizable=1,width=600,height=400' );
				return false;
			});
		});
		</script>
				<script type="text/javascript">
		jQuery(document).on( 'ready post-load', function(){
			jQuery( 'a.share-google-plus-1' ).on( 'click', function() {
				window.open( jQuery(this).attr( 'href' ), 'wpcomgoogle-plus-1', 'menubar=1,resizable=1,width=600,height=600' );
				return false;
			});
		});
		</script>
		<script type='text/javascript' src='http://platform.twitter.com/widgets.js?ver=20111117'></script>
<script type='text/javascript' src='http://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201311'></script>
<script type='text/javascript' src='http://s.gravatar.com/js/gprofiles.js?ver=2013Maraa'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.michaelhamrah.com/blog/wp-content/plugins/jetpack/modules/wpgroho.js?ver=3.5.1'></script>
<script type='text/javascript' src='http://www.michaelhamrah.com/blog/wp-content/themes/publish/js/small-menu.js?ver=20120206'></script>

	<script src="http://stats.wordpress.com/e-201311.js" type="text/javascript"></script>
	<script type="text/javascript">
	st_go({v:'ext',j:'1:2.2',blog:'5687098',post:'575',tz:'-4'});
	var load_cmc = function(){linktracker_init(5687098,575,2);};
	if ( typeof addLoadEvent != 'undefined' ) addLoadEvent(load_cmc);
	else load_cmc();
	</script>
</body>
</html>

<!-- Dynamic page generated in 0.160 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2013-03-15 09:54:21 -->

<!-- super cache -->